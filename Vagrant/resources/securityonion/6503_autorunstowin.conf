# Author: Wes Lambert
# wlambertts@gmail.com
#
# Last Update: 09/19/2018
#
# This conf file is based on accepting Autoruns logs from OSSEC
# using Palantir's AutorunsToWinEventLog
# https://github.com/palantir/windows-event-forwarding/tree/master/AutorunsToWinEventLog
#
# Parse using grok
filter {
  # OSSEC output from parsing similar to
  # https://wazuh.com/blog/using-wazuh-to-monitor-sysmon-events/
  if [type] == "autorunstowin" or "autorunstowin" in [tags] {
    if [message] =~ /^{.*}$/ {
        json {
                source => "message"
        }
        mutate {
        	rename => { "[data][EventChannel][EventData][Data]" => "data_field" }
        }
        grok {
          match => ["data_field", "Time%{SPACE}:%{SPACE}%{GREEDYDATA:time_stuff}Entry Location%{SPACE}:%{SPACE}%{DATA:entry_location}Entry%{SPACE}:%{SPACE}%{DATA:entry}Enabled%{SPACE}:%{SPACE}%{DATA:enabled}Category%{SPACE}:%{SPACE}%{DATA:category}Profile%{SPACE}:%{SPACE}%{DATA:profile}Description%{SPACE}:%{SPACE}%{DATA:description}Signer%{SPACE}:%{SPACE}%{DATA:signer}Company%{SPACE}:%{SPACE}%{DATA:company}Image\ Path%{SPACE}:%{SPACE}%{DATA:image_path}Version%{SPACE}:%{SPACE}%{DATA:version}Launch\ String%{SPACE}:%{SPACE}%{DATA:launch_string}VT\ detection%{SPACE}:%{SPACE}%{DATA:vt_detection}VT\ permalink%{SPACE}:%{SPACE}%{DATA:vt_permalink}MD5%{SPACE}:%{SPACE}%{DATA:md5}SHA-1%{SPACE}:%{SPACE}%{DATA:sha1}PESHA-1%{SPACE}:%{SPACE}%{DATA:pesha1}PESHA-256%{SPACE}:%{SPACE}%{DATA:pesha256}SHA-256%{SPACE}:%{SPACE}%{DATA:sha256}IMP%{SPACE}:%{SPACE}%{DATA:imphash}"]
        }
        mutate {
        	remove_field => ["data_field"]
                # will parse the following eventually...
        	remove_field => ["time_stuff"]
        }
    }
  }
}
